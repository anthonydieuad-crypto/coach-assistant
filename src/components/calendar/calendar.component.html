<div class="p-4 sm:p-6">
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-2xl font-bold text-white capitalize">{{ currentMonthLabel() }}</h2>
    <div class="flex items-center space-x-2">
      <button (click)="changeMonth(-1)" class="p-2 rounded-full text-gray-300 hover:bg-white/10">
        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>
      </button>
      <button (click)="changeMonth(1)" class="p-2 rounded-full text-gray-300 hover:bg-white/10">
        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
      </button>
      <button (click)="openModalForNew()" class="ml-4 inline-flex items-center px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white font-semibold rounded-lg shadow-md transition-colors duration-300">
        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
        Ajouter un événement
      </button>
    </div>
  </div>

  <div class="bg-slate-800/50 backdrop-blur-lg border border-white/10 rounded-lg shadow-lg overflow-hidden">
    <div class="grid grid-cols-7 gap-px border-b border-white/10">
      @for (day of daysOfWeek; track day) {
        <div class="text-center py-3 text-sm font-semibold text-gray-300">{{ day }}</div>
      }
    </div>
    <div class="grid grid-cols-7 gap-px bg-black/20">
      @for (day of calendarGrid(); track day.date.toISOString()) {
        <div (click)="openModalForNew(day.date)" class="relative min-h-28 p-2 cursor-pointer hover:bg-white/10 transition-colors bg-slate-800/30" [class.opacity-50]="!day.isCurrentMonth">
          <time [dateTime]="day.date.toISOString().split('T')[0]" 
                class="font-semibold"
                [class.text-slate-900]="isToday(day.date)"
                [class.bg-cyan-400]="isToday(day.date)"
                [class.text-white]="!isToday(day.date)"
                [class.w-7]="isToday(day.date)"
                [class.h-7]="isToday(day.date)"
                [class.rounded-full]="isToday(day.date)"
                [class.flex]="isToday(day.date)"
                [class.items-center]="isToday(day.date)"
                [class.justify-center]="isToday(day.date)">
            {{ day.date.getDate() }}
          </time>
          <div class="mt-1 space-y-1">
            @for (event of day.events; track event.id) {
              <div (click)="openModalForEdit(event); $event.stopPropagation()" class="text-xs p-1 rounded-md text-white hover:ring-2 hover:ring-offset-2 ring-offset-slate-800"
                  [class.bg-blue-500]="event.type === 'training'" [class.hover:ring-blue-400]="event.type === 'training'"
                  [class.bg-green-500]="event.type === 'plateau'" [class.hover:ring-green-400]="event.type === 'plateau'"
                  [class.bg-red-500]="event.type === 'match'" [class.hover:ring-red-400]="event.type === 'match'"
                  [class.bg-orange-500]="event.type === 'cohesion'" [class.hover:ring-orange-400]="event.type === 'cohesion'">
                <div class="font-semibold truncate">{{ event.title }}</div>
                <div class="text-white/90 truncate"><span class="font-medium">@</span> {{ event.location }}</div>
                @if (event.opponentTeams) {
                  <div class="text-white/90 truncate"><span class="font-medium">vs</span> {{ event.opponentTeams }}</div>
                }
              </div>
            }
          </div>
        </div>
      }
    </div>
  </div>
</div>

<!-- Modal for adding/editing event -->
@if (isModalOpen()) {
  <div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" (click)="closeModal()">
    <div class="bg-slate-800/80 backdrop-blur-lg border border-white/20 rounded-lg shadow-2xl p-6 w-full max-w-lg animate-fade-in" (click)="$event.stopPropagation()">
      <h3 class="text-xl font-bold text-white mb-4">
        {{ editingEventId() ? 'Modifier' : 'Ajouter' }} un événement
      </h3>
      <form (submit)="$event.preventDefault(); saveEvent()">
        <div class="space-y-4">
          <div>
            <label for="event-type" class="block text-sm font-medium text-gray-300">Type</label>
            <select id="event-type" [value]="newEvent().type" (change)="handleEventInput('type', $event)" class="mt-1 block w-full px-3 py-2 bg-slate-900/50 border border-slate-500 rounded-md shadow-sm focus:outline-none focus:ring-cyan-500 focus:border-cyan-500">
              <option value="training">Entraînement</option>
              <option value="plateau">Plateau</option>
              <option value="match">Match amical</option>
              <option value="cohesion">Sortie cohésion d'équipe</option>
            </select>
          </div>
          <div>
            <label for="event-date" class="block text-sm font-medium text-gray-300">Date</label>
            <input type="date" id="event-date" [value]="newEvent().date" (input)="handleEventInput('date', $event)" class="mt-1 block w-full px-3 py-2 bg-slate-900/50 border border-slate-500 rounded-md shadow-sm focus:outline-none focus:ring-cyan-500 focus:border-cyan-500" required>
          </div>
          <div>
            <label for="event-title" class="block text-sm font-medium text-gray-300">Titre</label>
            <input type="text" id="event-title" [value]="newEvent().title" (input)="handleEventInput('title', $event)" class="mt-1 block w-full px-3 py-2 bg-slate-900/50 border border-slate-500 rounded-md shadow-sm focus:outline-none focus:ring-cyan-500 focus:border-cyan-500" required>
          </div>
          <div>
            <label for="event-location" class="block text-sm font-medium text-gray-300">Lieu</label>
            <input type="text" id="event-location" [value]="newEvent().location" (input)="handleEventInput('location', $event)" placeholder="ex: Stade Municipal" class="mt-1 block w-full px-3 py-2 bg-slate-900/50 border border-slate-500 rounded-md shadow-sm focus:outline-none focus:ring-cyan-500 focus:border-cyan-500" required>
          </div>
          
          @if (newEvent().type === 'plateau' || newEvent().type === 'match') {
            <div>
              <label for="event-group" class="block text-sm font-medium text-gray-300">Groupe</label>
              <select id="event-group" [value]="newEvent().group ?? 'null'" (change)="handleEventInput('group', $event)" class="mt-1 block w-full px-3 py-2 bg-slate-900/50 border border-slate-500 rounded-md shadow-sm">
                <option value="null">Aucun</option>
                @for(group of playerGroups; track group) {
                  <option [value]="group">{{ group }}</option>
                }
              </select>
            </div>
            <div>
              <label for="event-opponents" class="block text-sm font-medium text-gray-300">Équipes adverses</label>
              <textarea id="event-opponents" rows="2" [value]="newEvent().opponentTeams" (input)="handleEventInput('opponentTeams', $event)" placeholder="ex: FC Voisins, US Amis" class="mt-1 block w-full px-3 py-2 bg-slate-900/50 border border-slate-500 rounded-md shadow-sm focus:outline-none focus:ring-cyan-500 focus:border-cyan-500"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300">Participants</label>
              <div class="mt-2 max-h-40 overflow-y-auto border border-slate-500 rounded-md p-2 space-y-2">
                @for (player of allPlayers(); track player.id) {
                  <label class="flex items-center">
                    <input type="checkbox" [checked]="newEvent().participants.includes(player.id)" (change)="handleParticipantToggle(player.id)" class="h-4 w-4 rounded border-gray-400 text-cyan-500 focus:ring-cyan-500 bg-transparent">
                    <span class="ml-2 text-sm text-gray-200">{{ player.firstName }} {{ player.lastName }}</span>
                  </label>
                }
              </div>
            </div>
          }
        </div>
        <div class="mt-6 flex justify-end space-x-3">
          <button type="button" (click)="closeModal()" class="px-4 py-2 bg-slate-600 text-gray-200 font-semibold rounded-lg hover:bg-slate-500">
            Annuler
          </button>
          <button type="submit" [disabled]="!newEvent().title.trim() || !newEvent().date || !newEvent().location.trim()" class="px-4 py-2 bg-cyan-600 text-white font-semibold rounded-lg shadow-md hover:bg-cyan-700 disabled:bg-gray-500 disabled:cursor-not-allowed">
            Enregistrer
          </button>
        </div>
      </form>
    </div>
  </div>
}
<style>
  @keyframes fade-in {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
  }
  .animate-fade-in {
    animation: fade-in 0.2s ease-out forwards;
  }
</style>